function _0x8e8a(_0x216b1e,_0xc699fe){const _0x3bc8f1=_0x3bc8();return _0x8e8a=function(_0x8e8acb,_0x3779a0){_0x8e8acb=_0x8e8acb-0x1b8;let _0x546051=_0x3bc8f1[_0x8e8acb];return _0x546051;},_0x8e8a(_0x216b1e,_0xc699fe);}const _0x4e979c=_0x8e8a;function _0x3bc8(){const _0x5ed6fe=['create','exports','child_process','proExtraSale','195hrKyqT','error','86601qHfdjs','10028007TWVDLw','true','csv-parser','proTaxRate','../models/store-model','proCode','../models/sale-model','close','toFixed','2743224FRUQnl','catch','553vvnYAt','proSale','express-async-handler','json','53652zgPVmT','stderr:\x20','pdfreader.py','proTotalVat','replace','رقم\x20الفاتورة\x20مسجل\x20من\x20قبل','40JNXNnx','2KQDaXx','12VUIduK','87848oBXbCi','false','params','status','findByIdAndUpdate','stdout','findByIdAndDelete','لا\x20توجد\x20فاتورة\x20بهذا\x20الرقم\x20','findOne','findById','productsInfo','values','reject','products','createReadStream','keys','body','proQuantity','log','send','abs','query','proCost','proName','path','invoiceTotal','../models/product-model','file','python','findOneAndUpdate','then','40uFvpQy','data','push','invoiceNumber','length','find','pipe','limit','15842541HXiUnK','1061122UOSwGO','الكمية\x20المطلوبة\x20اقل\x20من\x20الموجودة\x20في\x20المخزن'];_0x3bc8=function(){return _0x5ed6fe;};return _0x3bc8();}(function(_0x40f6dc,_0xa84cfc){const _0x3dd2ef=_0x8e8a,_0x4625e1=_0x40f6dc();while(!![]){try{const _0x4af47b=parseInt(_0x3dd2ef(0x1d9))/0x1*(-parseInt(_0x3dd2ef(0x1f8))/0x2)+parseInt(_0x3dd2ef(0x1e1))/0x3*(-parseInt(_0x3dd2ef(0x1f7))/0x4)+-parseInt(_0x3dd2ef(0x1df))/0x5*(parseInt(_0x3dd2ef(0x1f1))/0x6)+parseInt(_0x3dd2ef(0x1ed))/0x7*(-parseInt(_0x3dd2ef(0x1fa))/0x8)+parseInt(_0x3dd2ef(0x1e2))/0x9+parseInt(_0x3dd2ef(0x1d0))/0xa*(parseInt(_0x3dd2ef(0x1eb))/0xb)+-parseInt(_0x3dd2ef(0x1f9))/0xc*(-parseInt(_0x3dd2ef(0x1d8))/0xd);if(_0x4af47b===_0xa84cfc)break;else _0x4625e1['push'](_0x4625e1['shift']());}catch(_0x4cc7f2){_0x4625e1['push'](_0x4625e1['shift']());}}}(_0x3bc8,0xba9e3));const asyncHandler=require(_0x4e979c(0x1ef)),ApiError=require('../utils/apiError'),SaleInvoiceModel=require(_0x4e979c(0x1e8)),ProductModel=require(_0x4e979c(0x1cb)),StoreModel=require(_0x4e979c(0x1e6)),{spawn}=require(_0x4e979c(0x1dd)),fs=require('fs'),csv=require(_0x4e979c(0x1e4)),getProductInfo=async _0x413968=>{const _0x214884=_0x4e979c;var _0x2aa01e={'productsInfo':[],'invoiceTotal':0x0};for(var _0x4a6093=0x0;_0x4a6093<_0x413968[_0x214884(0x1d4)];_0x4a6093++){var _0x5219b8=await ProductModel['findOne']({'proCode':_0x413968[_0x4a6093]['proCode']}),_0x1d61de={'proCode':_0x5219b8['proCode'],'proName':_0x5219b8[_0x214884(0x1c8)],'proQuantity':_0x413968[_0x4a6093][_0x214884(0x1c2)],'proCost':_0x413968[_0x4a6093]['proCost'],'proSale':_0x413968[_0x4a6093]['proSale'],'proExtraSale':_0x413968[_0x4a6093][_0x214884(0x1de)],'proTaxRate':_0x413968[_0x4a6093]['proTaxRate'],'proTaxValue':_0x413968[_0x4a6093][_0x214884(0x1e5)]=='5'?Math[_0x214884(0x1c5)]((_0x413968[_0x4a6093][_0x214884(0x1c7)]*_0x413968[_0x4a6093][_0x214884(0x1c2)]-_0x413968[_0x4a6093][_0x214884(0x1ee)])*_0x413968[_0x4a6093]['proTaxRate']/0x69)[_0x214884(0x1ea)](0x2):Math[_0x214884(0x1c5)]((_0x413968[_0x4a6093]['proCost']*_0x413968[_0x4a6093][_0x214884(0x1c2)]-_0x413968[_0x4a6093]['proSale'])*_0x413968[_0x4a6093][_0x214884(0x1e5)]/0x72)[_0x214884(0x1ea)](0x2),'proTotalVat':Math['abs'](_0x413968[_0x4a6093]['proCost']*_0x413968[_0x4a6093][_0x214884(0x1c2)]-_0x413968[_0x4a6093][_0x214884(0x1ee)])};_0x2aa01e['invoiceTotal']=_0x2aa01e[_0x214884(0x1ca)]+_0x1d61de['proTotalVat'],_0x2aa01e['productsInfo'][_0x214884(0x1d2)](_0x1d61de);}return _0x2aa01e;},getStoreProducts=async _0xb46d93=>{const _0x3ea00a=_0x4e979c;let _0x453ee0=[];for(var _0x19c3e5=0x0;_0x19c3e5<_0xb46d93[_0x3ea00a(0x1d4)];_0x19c3e5++){var _0x1141c2=await StoreModel[_0x3ea00a(0x1ce)]({'proCode':_0xb46d93[_0x19c3e5]['proCode']},{'$inc':{'proQuantity':-_0xb46d93[_0x19c3e5]['proQuantity']}},{'new':!![]});(!_0x1141c2||_0x1141c2==undefined)&&_0x453ee0[_0x3ea00a(0x1d2)](_0xb46d93[_0x19c3e5]);}return _0x453ee0;},checkStoreQuantity=async _0x4212ec=>{const _0x19d499=_0x4e979c;let _0x714385=[];for(var _0x31ef29=0x0;_0x31ef29<_0x4212ec[_0x19d499(0x1d4)];_0x31ef29++){await StoreModel[_0x19d499(0x1b9)]({'proCode':_0x4212ec[_0x31ef29][_0x19d499(0x1e7)]})[_0x19d499(0x1cf)](_0x2ce262=>{const _0x4d41da=_0x19d499;_0x2ce262[_0x4d41da(0x1c2)]<_0x4212ec[_0x31ef29][_0x4d41da(0x1c2)]?_0x714385[_0x4d41da(0x1d2)](_0x4d41da(0x1fb)):_0x714385[_0x4d41da(0x1d2)](_0x4d41da(0x1e3));});}return _0x714385;};module[_0x4e979c(0x1dc)]={'createSaleInvoice':asyncHandler(async(_0x374d8e,_0x1ba4f0,_0x34e474)=>{const _0x4647c6=_0x4e979c;var _0x44953d=await SaleInvoiceModel[_0x4647c6(0x1b9)]({'invoiceNumber':_0x374d8e['body'][_0x4647c6(0x1d3)]});if(_0x44953d)_0x34e474(new ApiError(_0x4647c6(0x1f6),0x190));else{var _0x2370a8=_0x374d8e[_0x4647c6(0x1cc)][_0x4647c6(0x1c9)],_0x7df021=_0x374d8e['body']['invoiceNumber'],_0x337112=[],_0x3d3d08=[],_0x464214=[],_0x1d0f12=0x0;const _0x50d50e=spawn(_0x4647c6(0x1cd),[_0x4647c6(0x1f3),_0x374d8e[_0x4647c6(0x1cc)]['path']]);_0x50d50e[_0x4647c6(0x1ff)]['on'](_0x4647c6(0x1d1),_0x5a6e22=>{const _0x252c83=_0x4647c6;for(var _0x5b8816=0x0;_0x5b8816<_0x5a6e22;_0x5b8816++){fs[_0x252c83(0x1bf)](__dirname+('/table_'+_0x5b8816+'.csv'))[_0x252c83(0x1d6)](csv())['on'](_0x252c83(0x1d1),_0x572c1b=>{_0x337112['push'](_0x572c1b);})['on']('end',async()=>{const _0x17e077=_0x252c83;for(var _0x2ac609=0x0;_0x2ac609<_0x337112[_0x17e077(0x1d4)];_0x2ac609++){if(Object[_0x17e077(0x1bc)](_0x337112[_0x2ac609])[Object[_0x17e077(0x1c0)](_0x337112[_0x2ac609])['length']-0x1]=='')continue;var _0x19236c=Object['values'](_0x337112[_0x2ac609])[Object[_0x17e077(0x1c0)](_0x337112[_0x2ac609])['length']-0x1]['replace']('.0','');await ProductModel['findOne']({'proCode':_0x19236c})[_0x17e077(0x1cf)](_0x2f3256=>{const _0x50923e=_0x17e077;if(_0x2f3256){if(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x6]==''){var _0x35ebb2={'proCode':_0x19236c,'proName':_0x2f3256[_0x50923e(0x1c8)],'proQuantity':Number(Object['values'](_0x337112[_0x2ac609])[0x8][_0x50923e(0x1f5)](',','')),'proCost':Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x7][_0x50923e(0x1f5)](',','')),'proSale':Math[_0x50923e(0x1c5)](Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x4]['replace'](',',''))),'proExtraSale':Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x3][_0x50923e(0x1f5)](',','')),'proTaxRate':Number(Object['values'](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',','')),'proTaxValue':Number(Object['values'](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',',''))==0x5?Math['abs']((Number(Object['values'](_0x337112[_0x2ac609])[0x7][_0x50923e(0x1f5)](',',''))*Number(Object['values'](_0x337112[_0x2ac609])[0x8][_0x50923e(0x1f5)](',',''))-Math['abs'](Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x4][_0x50923e(0x1f5)](',',''))))*Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',',''))/0x69)[_0x50923e(0x1ea)](0x2):Math['abs']((Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x7]['replace'](',',''))*Number(Object['values'](_0x337112[_0x2ac609])[0x8]['replace'](',',''))-Math[_0x50923e(0x1c5)](Number(Object['values'](_0x337112[_0x2ac609])[0x4][_0x50923e(0x1f5)](',',''))))*Number(Object['values'](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',',''))/0x72)[_0x50923e(0x1ea)](0x2),'proTotalVat':Math[_0x50923e(0x1c5)](Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x7][_0x50923e(0x1f5)](',',''))*Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x8][_0x50923e(0x1f5)](',',''))-Math[_0x50923e(0x1c5)](Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x4]['replace'](',',''))))};_0x1d0f12=_0x1d0f12+_0x35ebb2[_0x50923e(0x1f4)],_0x3d3d08[_0x50923e(0x1d2)](_0x35ebb2);}else{var _0x35ebb2={'proCode':_0x19236c,'proName':_0x2f3256[_0x50923e(0x1c8)],'proQuantity':Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x7][_0x50923e(0x1f5)](',','')),'proCost':Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x6]['replace'](',','')),'proSale':Math[_0x50923e(0x1c5)](Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x4][_0x50923e(0x1f5)](',',''))),'proExtraSale':Number(Object['values'](_0x337112[_0x2ac609])[0x3][_0x50923e(0x1f5)](',','')),'proTaxRate':Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',','')),'proTaxValue':Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',',''))==0x5?Math[_0x50923e(0x1c5)]((Number(Object['values'](_0x337112[_0x2ac609])[0x6][_0x50923e(0x1f5)](',',''))*Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x7][_0x50923e(0x1f5)](',',''))-Math['abs'](Number(Object['values'](_0x337112[_0x2ac609])[0x4][_0x50923e(0x1f5)](',',''))))*Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',',''))/0x69)['toFixed'](0x2):Math[_0x50923e(0x1c5)]((Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x6][_0x50923e(0x1f5)](',',''))*Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x7]['replace'](',',''))-Math[_0x50923e(0x1c5)](Number(Object['values'](_0x337112[_0x2ac609])[0x4][_0x50923e(0x1f5)](',',''))))*Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x2][_0x50923e(0x1f5)](',',''))/0x72)['toFixed'](0x2),'proTotalVat':Math['abs'](Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x6][_0x50923e(0x1f5)](',',''))*Number(Object[_0x50923e(0x1bc)](_0x337112[_0x2ac609])[0x7][_0x50923e(0x1f5)](',',''))-Math[_0x50923e(0x1c5)](Number(Object['values'](_0x337112[_0x2ac609])[0x4][_0x50923e(0x1f5)](',',''))))};_0x1d0f12=_0x1d0f12+_0x35ebb2[_0x50923e(0x1f4)],_0x3d3d08[_0x50923e(0x1d2)](_0x35ebb2);}}else _0x464214['push'](_0x19236c);})[_0x17e077(0x1ec)](_0x51912a=>{const _0x296489=_0x17e077;return Promise[_0x296489(0x1bd)](_0x51912a);});}if(_0x464214['length']==0x0){var _0x413cb2=await checkStoreQuantity(_0x3d3d08);if(_0x413cb2['includes'](_0x17e077(0x1fb)))_0x34e474(new ApiError(_0x17e077(0x1da),0x190));else{var _0x34af56=await getStoreProducts(_0x3d3d08),_0x372cd5=await SaleInvoiceModel[_0x17e077(0x1b9)]({'invoiceNumber':_0x7df021});if(!_0x372cd5)await SaleInvoiceModel[_0x17e077(0x1db)]({'invoiceUrl':_0x2370a8,'invoiceNumber':_0x7df021,'products':_0x3d3d08,'invoiceTotal':_0x1d0f12})['then'](_0x59856d=>{const _0x40be22=_0x17e077;_0x1ba4f0['status'](0xc9)[_0x40be22(0x1f0)]({'data':_0x59856d});})[_0x17e077(0x1ec)](_0xb25432=>{const _0x4e7f8a=_0x17e077;_0x1ba4f0[_0x4e7f8a(0x1c4)](_0xb25432);});else{var _0x569ed2=_0x372cd5[_0x17e077(0x1be)][_0x17e077(0x1d2)](_0x3d3d08);await SaleInvoiceModel[_0x17e077(0x1ce)]({'invoiceNumber':_0x7df021},{'products':_0x569ed2,'$inc':{'invoiceTotal':_0x1d0f12}},{'new':!![]})[_0x17e077(0x1cf)](_0x293ee7=>{const _0x556f7a=_0x17e077;_0x1ba4f0[_0x556f7a(0x1fd)](0xc8)['json']({'data':_0x293ee7});})[_0x17e077(0x1ec)](_0x4aa0bd=>{const _0x22fcd2=_0x17e077;_0x1ba4f0[_0x22fcd2(0x1c4)](_0x4aa0bd);});}}}else _0x34e474(new ApiError('لا\x20يوجد\x20صنف\x20بهذا\x20الكود:\x20'+_0x464214+'\x20قم\x20بادخاله\x20اولا',0x190));});}}),_0x50d50e['stderr']['on']('data',_0x49b2ef=>{const _0x49f30a=_0x4647c6;console[_0x49f30a(0x1e0)](_0x49f30a(0x1f2)+_0x49b2ef);}),_0x50d50e['on'](_0x4647c6(0x1e9),_0x37193c=>{const _0x335d5b=_0x4647c6;console[_0x335d5b(0x1c3)](_0x37193c);});}}),'addInvoice':asyncHandler(async(_0x57c7ae,_0x10e36e)=>{const _0x4fb166=_0x4e979c,_0x5b5b74=_0x57c7ae[_0x4fb166(0x1c1)][_0x4fb166(0x1d3)],_0x2daef4=_0x57c7ae[_0x4fb166(0x1c1)]['products'],_0x19583d=await getProductInfo(_0x2daef4),_0x542eaf=await getStoreProducts(_0x19583d[_0x4fb166(0x1bb)]),_0x43fd15=await SaleInvoiceModel[_0x4fb166(0x1db)]({'invoiceNumber':_0x5b5b74,'products':_0x19583d[_0x4fb166(0x1bb)],'invoiceTotal':_0x19583d[_0x4fb166(0x1ca)]});_0x10e36e['status'](0xc9)['json']({'data':_0x43fd15});}),'getInvoices':asyncHandler(async(_0x289481,_0x494b1f)=>{const _0x2d097d=_0x4e979c,_0x597a14=_0x289481['query']['page']*0x1||0x1,_0x50dae2=_0x289481[_0x2d097d(0x1c6)][_0x2d097d(0x1d7)]*0x1||0x14,_0x4b632a=(_0x597a14-0x1)*_0x50dae2,_0x178233=await SaleInvoiceModel[_0x2d097d(0x1d5)]({});_0x494b1f['status'](0xc8)[_0x2d097d(0x1f0)]({'results':_0x178233[_0x2d097d(0x1d4)],'page':_0x597a14,'data':_0x178233['slice'](_0x4b632a,_0x50dae2*_0x597a14)});}),'getInvoice':asyncHandler(async(_0x325bce,_0x56b412,_0x48b09b)=>{const _0x2bad0e=_0x4e979c,{id:_0x3f418d}=_0x325bce['params'],_0x2a49ab=await SaleInvoiceModel[_0x2bad0e(0x1ba)](_0x3f418d);!_0x2a49ab?_0x48b09b(new ApiError(_0x2bad0e(0x1b8)+_0x3f418d,0x194)):_0x56b412[_0x2bad0e(0x1fd)](0xc8)[_0x2bad0e(0x1f0)]({'data':_0x2a49ab});}),'updateInvoice':asyncHandler(async(_0x1f7057,_0x2561e8,_0x5e63fe)=>{const _0x25917d=_0x4e979c,{id:_0x782c07}=_0x1f7057[_0x25917d(0x1fc)],_0x1149cd=_0x1f7057[_0x25917d(0x1c1)]['invoiceNumber'],_0x32606e=_0x1f7057[_0x25917d(0x1c1)]['products'],_0x1e937=await SaleInvoiceModel[_0x25917d(0x1fe)]({'_id':_0x782c07},{'invoiceNumber':_0x1149cd,'products':_0x32606e},{'new':!![]});!_0x1e937?_0x5e63fe(new ApiError(_0x25917d(0x1b8)+_0x782c07,0x194)):_0x2561e8[_0x25917d(0x1fd)](0xc8)[_0x25917d(0x1f0)]({'data':_0x1e937});}),'deleteInvoice':asyncHandler(async(_0x7fb3a2,_0x45351c,_0x3c98d6)=>{const _0x1e009f=_0x4e979c,{id:_0x5c1e37}=_0x7fb3a2['params'],_0x28c9c8=await SaleInvoiceModel[_0x1e009f(0x200)]({'_id':_0x5c1e37});!_0x28c9c8?_0x3c98d6(new ApiError(_0x1e009f(0x1b8)+_0x5c1e37,0x194)):_0x45351c[_0x1e009f(0x1fd)](0xcc)[_0x1e009f(0x1c4)]();})};